name: Branch Protection Rules

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

jobs:
  # Enforce branch naming
  branch-naming:
    name: Check Branch Name
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          
          # Valid patterns: feature/*, bugfix/*, hotfix/*, release/*
          if [[ ! $BRANCH_NAME =~ ^(feature|bugfix|hotfix|release)/.+ ]]; then
            echo "❌ Invalid branch name: $BRANCH_NAME"
            echo "Branch names must follow the pattern:"
            echo "  - feature/description"
            echo "  - bugfix/description"
            echo "  - hotfix/description"
            echo "  - release/version"
            exit 1
          fi
          
          echo "✅ Branch name is valid: $BRANCH_NAME"

  # Require PR description
  pr-description:
    name: Check PR Description
    runs-on: ubuntu-latest
    steps:
      - name: Check PR body
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            if (body.length < 50) {
              core.setFailed('❌ PR description is too short. Please provide a detailed description (minimum 50 characters).');
            } else {
              console.log('✅ PR description is adequate');
            }

  # Check for breaking changes
  breaking-changes:
    name: Check for Breaking Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for breaking changes
        run: |
          # Check commit messages for BREAKING CHANGE
          BREAKING=$(git log origin/${{ github.base_ref }}..HEAD --grep="BREAKING CHANGE" --oneline)
          
          if [ ! -z "$BREAKING" ]; then
            echo "⚠️ BREAKING CHANGES detected:"
            echo "$BREAKING"
            echo ""
            echo "Please ensure:"
            echo "1. Version is bumped appropriately"
            echo "2. Migration guide is included"
            echo "3. Changelog is updated"
          else
            echo "✅ No breaking changes detected"
          fi

  # Require reviewers
  require-reviewers:
    name: Check Reviewers
    runs-on: ubuntu-latest
    steps:
      - name: Check for reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const approvals = reviews.data.filter(review => review.state === 'APPROVED');
            
            if (approvals.length === 0) {
              console.log('⚠️ No approvals yet. Waiting for code review...');
            } else {
              console.log(`✅ ${approvals.length} approval(s) received`);
            }

  # Check for merge conflicts
  merge-conflict-check:
    name: Check for Merge Conflicts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q "<<<<<"; then
            echo "❌ Merge conflicts detected!"
            echo "Please resolve conflicts before merging"
            exit 1
          else
            echo "✅ No merge conflicts"
          fi
